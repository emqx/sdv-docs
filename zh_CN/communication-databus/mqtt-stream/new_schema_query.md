# 通过 Schema 查询 Parquet 数据

## 1. 背景

使用 Schema 优化后的 Parquet 文件通常会显著减少文件大小。这是因为 Parquet 文件格式是列式存储的，通过 Schema 可以高效地组织数据，从而实现更高的压缩比和更快的数据读取性能。

## 2. 查询方式

当前系统支持两种查询模式：同步（sync）和异步（async）。流处理引擎通过消息通路向数据总线发起查询命令，格式如下：

```
sync-1-1792214350084-3110236524542341
```

- **第一个参数**：`sync` 或 `async`
	- `sync`: 同步查询，所有数据一次性返回给流处理引擎。
	- `async`: 异步查询，每个 Parquet 文件的数据会分开作为单独的消息返回，建议使用此方式，因为 `sync` 可能会导致数据总线内存峰值升高。
- **第二个参数**：开始时间戳（单位为毫秒）
- **第三个参数**：结束时间戳（单位为毫秒）
- **第四个参数**：需要查询的 Schema，这需要用户定义并提供解析函数进行解析。

### 2.1 查询方式解读

- **同步查询（sync）**：一次性将所有数据从所有 Parquet 文件中取出，适用于数据量较小的情况。但对于大数据量，可能会导致内存压力大。
- **异步查询（async）**：每个 Parquet 文件的数据会分开作为单独的消息返回，建议使用此方式。消息总线会每隔 1 秒查询一个 Parquet 文件，以避免一次性加载过多数据。

**示例**：

```
sync-1-1792214350084-3110236524542341
```

- **sync**：选择同步查询模式
- **1**：查询的开始时间戳
- **1792214350084**：查询的结束时间戳
- **3110236524542341**：Schema，按照 4 个字符为一个 Schema 进行解析，得到 `3110`、`2365`、`2454` 和 `2341`四个 Schema。消息总线会使用这四个 Schema 查询对应的 Parquet 文件，查询结果会被解码后返回给流处理引擎。

## 3. 备注

请结合《可灵活配置的流模组，实现数据灵活落盘》一章，深入了解数据流的解码和编码流程。这将有助于理解数据如何从 Parquet 文件中提取，并如何根据 Schema 进行解码和处理。
