# DBC 配置

DBC 表示“CAN数据库”，它是一种用于描述 CAN（控制器局域网）通信中数据结构的文件格式。它提供了一种标准化的方式来定义 CAN 总线系统的消息、信号、属性和值。DBC 文件通常用于汽车行业的车辆网络通信，但也可以在其他实施 CAN 总线的应用中使用。

DBC 文件定义的信息包括：

- 消息定义：CAN总线上的每条消息都定义了一个唯一的标识符和它携带的一组信号。
- 信号定义：消息中的每个信号都进行了描述，包括它的起始位、长度、类型、比例、偏移量和测量单位。
- 属性：这些可以包括有关消息或信号的信息，例如它是否是周期性消息、它的最小值和最大值等。
- 值描述：这些为某些信号的值提供人类可读的名称。 DBC文件通过提供一种清晰一致的方式来理解网络上传输的数据，从而促进了CAN总线系统的开发。它们还与模拟、测试和诊断CAN总线系统的工具备结合使用。

## DBC 与 CAN 相关格式

DBC 用于 CAN 相关格式的 **schema** 定义。 它定义了直接影响解析结果的消息、信号和值。在以下例子中，DBC 定义了 ID 为 100 的消息，以及该消息包含的信号等。

```dbc
BO_ 100 Mess0: 8 Vector__XXX
 SG_ Mess0_Sig1 : 1|10@0+ (1,0) [0|1023] "" Vector__XXX
 SG_ Mess0_Sig2 : 33|10@0+ (1,0) [0|1023] "" Vector__XXX
 SG_ Mess0_Sig3 : 39|1@0+ (1,0) [0|1] "" Vector__XXX
```

一旦我们接收到一个 ID 为 100 的 CAN 帧，我们会将其解析为映射到 DBC 中定义的消息/信号的内部结构。

```json
{
  "Mess0": {
    "Mess0_Sig1": 100,
    "Mess0_Sig2": 1000,
    "Mess0_Sig3": 0
  }
}
```

在流处理 SQL 语句中，我们可以通过 `Mess0.Mess0_Sig1` 访问解析出的信号。

## DBC 配置

使用 `can` 或者 `canjson` 格式时，DBC 用于定义 schema，是必须设置的属性。通过属性 SCHEMAID 配置 DBC 文件的路径。

```sql
create stream canDemo () WITH (TYPE="can", CONF_KEY="default", FORMAT="can", SHARED="true", SCHEMAID="dbc")
```

在这个例子中，格式是`can`，schemaId是`dbc`，这意味着如果 eKuiper 以相对路径模式启动，DBC 文件位于{{ekuiper root}}/dbc 文件夹中。其他有效的设置示例包括：

- `SCHEMAID="/opt/dbc"`: 指定 DBC 文件夹为绝对路径 `/opt/dbc`
- `SCHEMAID="/opt/dbc/sample.dbc"`: 指定单个 DBC 文件路径。可配置一个文件或文件夹作为路径。

### 二进制嵌入 DBC

如果 SchemaID 没有设置，我们将使用编译到可执行二进制文件中的嵌入式 DBC。这对于保护隐私很有用。

要编译嵌入式 DBC，只需将 DBC 文件放入源代码中的 dbc 文件夹并运行 make 命令进行编译。

## DBC 加载机制

- DBC将在运行时按需加载，这意味着它只有在规则需要时才会被加载。
- 相同的DBC只加载一次，并由所有规则共享，以节省内存使用。
- 如果 schemaId 是一个文件夹，里面所有的 DBC 文件将按照文件名的顺序被解析。如果消息定义发生冲突，后解析的消息定义将替换之前解析的。

